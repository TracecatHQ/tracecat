## AWS deployment with External Secrets Operator
## Prerequisites:
##   - ESO installed (helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace)
##   - ClusterSecretStore created with IRSA authentication
##   - AWS Secrets Manager secrets created with required keys
##   - AWS Load Balancer Controller installed
##   - RDS PostgreSQL instance
##   - ElastiCache Redis cluster
##   - S3 buckets for blob storage

# ESO manages secrets - leave existingSecret empty
secrets:
  existingSecret: ""

# External Secrets Operator configuration
externalSecrets:
  enabled: true
  refreshInterval: "1m"

  # Reference to ClusterSecretStore (created by platform team or Terraform)
  clusterSecretStoreRef: "tracecat-aws-secrets"

  # Core Tracecat secrets from AWS Secrets Manager
  # Expected JSON: { "dbEncryptionKey": "...", "serviceKey": "...", "signingSecret": "...", "userAuthSecret": "..." }
  coreSecrets:
    enabled: true
    secretArn: "arn:aws:secretsmanager:us-east-1:123456789:secret:tracecat/core-AbCdEf"
    targetSecretName: "tracecat-secrets"

  # PostgreSQL credentials (RDS master user secret)
  # Expected JSON: { "username": "...", "password": "..." }
  postgres:
    enabled: true
    secretArn: "arn:aws:secretsmanager:us-east-1:123456789:secret:rds!db-xxxx"
    targetSecretName: "tracecat-postgres-credentials"

  # Redis URL (ElastiCache)
  # Expected: raw Redis URL string (rediss://:password@host:port)
  redis:
    enabled: true
    secretArn: "arn:aws:secretsmanager:us-east-1:123456789:secret:tracecat/redis-AbCdEf"
    targetSecretName: "tracecat-redis-credentials"

# Explicit public URLs (required for ALB since TLS is terminated at load balancer)
urls:
  publicApp: https://tracecat.example.com
  publicApi: https://tracecat.example.com/api

tracecat:
  auth:
    superadminEmail: admin@example.com
  blobStorage:
    endpoint: ""  # Leave empty for AWS S3
    buckets:
      attachments: my-tracecat-attachments
      registry: my-tracecat-registry

ingress:
  enabled: true
  className: alb
  host: tracecat.example.com
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:us-east-1:123456789:certificate/xxx
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/healthcheck-path: /ready
    alb.ingress.kubernetes.io/healthcheck-port: "8000"

# Disable internal subcharts (using AWS managed services)
postgres:
  enabled: false
redis:
  enabled: false
minio:
  enabled: false

# Self-hosted Temporal with RDS persistence
temporal:
  enabled: true
  server:
    config:
      persistence:
        defaultStore: default
        visibilityStore: visibility
        numHistoryShards: 1024
        datastores:
          default:
            sql:
              pluginName: postgres12
              databaseName: temporal
              connectAddr: tracecat-db.xxxx.us-east-1.rds.amazonaws.com:5432
              user: tracecat
              # ESO creates this secret from externalSecrets.postgres
              existingSecret: tracecat-postgres-credentials
              secretKey: password
              createDatabase: false
              manageSchema: true
          visibility:
            sql:
              pluginName: postgres12
              databaseName: temporal_visibility
              connectAddr: tracecat-db.xxxx.us-east-1.rds.amazonaws.com:5432
              user: tracecat
              existingSecret: tracecat-postgres-credentials
              secretKey: password
              createDatabase: false
              manageSchema: true

# External services (ESO creates the referenced secrets)
externalPostgres:
  enabled: true
  host: tracecat-db.xxxx.us-east-1.rds.amazonaws.com
  port: 5432
  database: tracecat
  sslMode: require
  auth:
    # ESO creates this secret from externalSecrets.postgres
    existingSecret: tracecat-postgres-credentials

externalRedis:
  enabled: true
  auth:
    # ESO creates this secret from externalSecrets.redis
    existingSecret: tracecat-redis-credentials

externalS3:
  enabled: true
  endpoint: ""
  region: us-east-1
  # Use IRSA/IAM roles for S3 access (no keys required)

serviceAccount:
  # IRSA role for S3 access
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/tracecat-s3-role
