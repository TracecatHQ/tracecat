{{/*
External Secrets Operator Resources
Syncs secrets from AWS Secrets Manager into Kubernetes Secrets.
*/}}

{{- if .Values.externalSecrets.enabled }}

{{/*
=============================================================================
Core Tracecat Secrets ExternalSecret
Keys: dbEncryptionKey, serviceKey, signingSecret, userAuthSecret
=============================================================================
*/}}
{{- if and .Values.externalSecrets.coreSecrets.enabled .Values.externalSecrets.coreSecrets.secretArn }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "tracecat.fullname" . }}-core-secrets
  labels:
    {{- include "tracecat.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: ClusterSecretStore
    name: {{ required "externalSecrets.clusterSecretStoreRef is required when ESO is enabled" .Values.externalSecrets.clusterSecretStoreRef }}
  target:
    name: {{ .Values.externalSecrets.coreSecrets.targetSecretName }}
    creationPolicy: Owner
  data:
    - secretKey: dbEncryptionKey
      remoteRef:
        key: {{ .Values.externalSecrets.coreSecrets.secretArn }}
        property: dbEncryptionKey
    - secretKey: serviceKey
      remoteRef:
        key: {{ .Values.externalSecrets.coreSecrets.secretArn }}
        property: serviceKey
    - secretKey: signingSecret
      remoteRef:
        key: {{ .Values.externalSecrets.coreSecrets.secretArn }}
        property: signingSecret
    - secretKey: userAuthSecret
      remoteRef:
        key: {{ .Values.externalSecrets.coreSecrets.secretArn }}
        property: userAuthSecret
---
{{- end }}

{{/*
=============================================================================
PostgreSQL Credentials ExternalSecret
Keys: username, password
=============================================================================
*/}}
{{- if and .Values.externalSecrets.postgres.enabled .Values.externalSecrets.postgres.secretArn }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "tracecat.fullname" . }}-postgres-secrets
  labels:
    {{- include "tracecat.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: ClusterSecretStore
    name: {{ required "externalSecrets.clusterSecretStoreRef is required when ESO is enabled" .Values.externalSecrets.clusterSecretStoreRef }}
  target:
    name: {{ .Values.externalSecrets.postgres.targetSecretName }}
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
    - secretKey: username
      remoteRef:
        key: {{ .Values.externalSecrets.postgres.secretArn }}
        property: username
    - secretKey: password
      remoteRef:
        key: {{ .Values.externalSecrets.postgres.secretArn }}
        property: password
---
{{- end }}

{{/*
=============================================================================
Redis URL ExternalSecret
Keys: url
=============================================================================
*/}}
{{- if and .Values.externalSecrets.redis.enabled .Values.externalSecrets.redis.secretArn }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "tracecat.fullname" . }}-redis-secrets
  labels:
    {{- include "tracecat.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: ClusterSecretStore
    name: {{ required "externalSecrets.clusterSecretStoreRef is required when ESO is enabled" .Values.externalSecrets.clusterSecretStoreRef }}
  target:
    name: {{ .Values.externalSecrets.redis.targetSecretName }}
    creationPolicy: Owner
  data:
    - secretKey: url
      remoteRef:
        key: {{ .Values.externalSecrets.redis.secretArn }}
---
{{- end }}

{{/*
=============================================================================
Temporal Cloud API Key ExternalSecret
Keys: apiKey
=============================================================================
*/}}
{{- if and .Values.externalSecrets.temporal.enabled .Values.externalSecrets.temporal.secretArn }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "tracecat.fullname" . }}-temporal-secrets
  labels:
    {{- include "tracecat.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: ClusterSecretStore
    name: {{ required "externalSecrets.clusterSecretStoreRef is required when ESO is enabled" .Values.externalSecrets.clusterSecretStoreRef }}
  target:
    name: {{ .Values.externalSecrets.temporal.targetSecretName }}
    creationPolicy: Owner
  data:
    - secretKey: apiKey
      remoteRef:
        key: {{ .Values.externalSecrets.temporal.secretArn }}
{{- end }}

{{- end }}
