# Core secrets (REQUIRED)
secrets:
  # Name of existing Kubernetes Secret containing:
  # - dbEncryptionKey: URL-safe base64 key for DB encryption
  # - serviceKey: Service-to-service auth key (hex)
  # - signingSecret: Webhook signing secret (hex)
  # - userAuthSecret: Password reset/email verification token secret (hex)
  # Leave empty when using secrets.create.tracecat or externalSecrets.coreSecrets.
  existingSecret: ""

  # Optional native K8s Secret manifests rendered by this chart.
  # Useful when you do not use External Secrets Operator.
  # These are rendered as pre-install/pre-upgrade hooks (weight -15) so
  # they exist before the pre-install/pre-upgrade migrations job (weight -5).
  create:
    tracecat:
      enabled: false
      name: "tracecat-secrets"
      dbEncryptionKey: ""
      serviceKey: ""
      signingSecret: ""
      userAuthSecret: ""

    postgres:
      enabled: false
      # Keep this aligned with externalPostgres.auth.existingSecret unless you
      # explicitly override the app DB secret name.
      name: "tracecat-postgres-credentials"
      username: ""
      password: ""

    temporalUiOidc:
      enabled: false
      name: "temporal-ui-oidc"
      clientId: ""
      clientSecret: ""

    redis:
      enabled: false
      # Keep this aligned with externalRedis.auth.existingSecret unless you
      # explicitly override the Redis secret name.
      name: "tracecat-redis-credentials"
      url: ""


# External Secrets Operator integration (optional)
# When enabled, ESO syncs secrets from AWS Secrets Manager into K8s Secrets.
externalSecrets:
  enabled: false
  refreshInterval: "1m"

  # Reference to an existing ClusterSecretStore (recommended for AWS with IRSA)
  clusterSecretStoreRef: ""

  # Core Tracecat secrets (REQUIRED when enabled)
  # Expected JSON: { "dbEncryptionKey": "...", "serviceKey": "...", "signingSecret": "...", "userAuthSecret": "..." }
  coreSecrets:
    enabled: true
    secretArn: ""
    targetSecretName: "tracecat-secrets"

  # PostgreSQL credentials for externalPostgres
  # Expected JSON: { "username": "...", "password": "..." }
  postgres:
    enabled: false
    secretArn: ""
    targetSecretName: "tracecat-postgres-credentials"

  # Redis URL for externalRedis
  # Expected: raw Redis URL string (rediss://:password@host:port for TLS)
  redis:
    enabled: false
    secretArn: ""
    targetSecretName: "tracecat-redis-credentials"

  # Temporal Cloud API key for externalTemporal
  # Expected: raw API key string
  temporal:
    enabled: false
    secretArn: ""
    targetSecretName: "tracecat-temporal-credentials"

# Pod annotations applied to all Tracecat workloads (e.g., Istio sidecar config).
podAnnotations: {}

# Service account for Tracecat workloads (api/worker/executor/temporal-setup).
# Migration jobs use a dedicated hook SA (migrations-sa.yaml) created before the job runs.
serviceAccount:
  create: true
  name: ""
  annotations: {}

# Backend image configuration
image:
  repository: ghcr.io/tracecathq/tracecat
  pullPolicy: IfNotPresent
  # tag: "" # Defaults to Chart.AppVersion

# Frontend image configuration
uiImage:
  repository: ghcr.io/tracecathq/tracecat-ui
  pullPolicy: IfNotPresent
  # tag: "" # Defaults to Chart.AppVersion

securityContext:
  fsGroup: 1001
  runAsUser: 1001

scheduling:
  # Global pod scheduling defaults for all Tracecat workloads.
  nodeSelector: {}
  affinity: {}
  topologySpreadConstraints: []
  tolerations: []

ingress:
  enabled: true
  className: ""
  annotations: {}
  host: tracecat.example.com
  tls: []
  split: false
  ui:
    annotations: {}
  api:
    annotations: {}

# Istio VirtualService configuration (alternative to ingress).
# Disable ingress when enabling VirtualServices.
virtualService:
  enabled: false
  apiVersion: networking.istio.io/v1beta1

  # Routes /api and / to Tracecat API/UI services.
  tracecat:
    enabled: true
    # Render one VirtualService per entry.
    configs: []

  # Optional webhook-only VirtualServices.
  # Routes /_/webhooks and /webhooks to the Tracecat API service.
  webhooks:
    enabled: false
    timeout: 5s
    # Render one VirtualService per entry.
    configs: []

  # Optional Temporal Web UI VirtualServices for self-hosted Temporal.
  temporal:
    enabled: false
    # Render one VirtualService per entry.
    configs: []

urls:
  publicApp: ""
  publicApi: ""
  # Only used to rewrite presigned URLs for S3-compatible storage.
  publicS3: ""

tracecat:
  appEnv: production
  logLevel: "INFO"
  allowOrigins: ""
  sentryDsn: ""
  # Core feature flags (comma-separated).
  featureFlags: ""

  sandbox:
    disableNsjail: false

  blobStorage:
    # Optional override for S3-compatible endpoints (leave empty for AWS S3).
    endpoint: ""
    buckets:
      # Defaults to tracecat-attachments if unset.
      attachments: ""
      # Defaults to tracecat-registry if unset.
      registry: ""

  saml:
    enabled: false
    idpMetadataUrl: ""
    allowUnsolicited: "false"
    acceptedTimeDiff: ""
    authnRequestsSigned: "false"
    signedAssertions: "true"
    signedResponses: "true"
    verifySslEntity: "true"
    verifySslMetadata: "true"
    caCerts: ""
    metadataCert: ""

  auth:
    types: "oidc"
    allowedDomains: ""
    superadminEmail: ""

  oidc:
    issuer: ""
    clientId: ""
    clientSecret: ""
    scopes: ""

  temporal:
    # Search attributes to create in Temporal (name: type)
    # Types: Keyword, Text, Int, Double, Bool, Datetime, KeywordList
    searchAttributes:
      TracecatTriggerType: Keyword
      TracecatTriggeredByUserId: Keyword
      TracecatWorkspaceId: Keyword
      TracecatAlias: Keyword
      TracecatExecutionType: Keyword

    # Temporal SDK metrics (Prometheus endpoint exposed by Tracecat processes that connect to Temporal).
    # This is controlled via TEMPORAL__METRICS_PORT in Tracecat.
    metrics:
      enabled: false
      port: 9000
      path: /metrics
      # Adds Prometheus scrape annotations to pods/services.
      scrape: true

enterprise:
  # Enterprise-only feature flags (comma-separated).
  # These are appended to tracecat.featureFlags.
  featureFlags: ""
  # Enable enterprise multi-tenant mode.
  multiTenant: false

ui:
  replicas: 1
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

api:
  replicas: 1
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

worker:
  replicas: 1
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  contextCompression:
    enabled: false
    thresholdKb: 16

executor:
  replicas: 1
  # Executor backend: 'pool', 'ephemeral', 'direct', or 'auto' (default)
  backend: "auto"
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  queue: "shared-action-queue"
  workerPoolSize: ""
  contextCompression:
    enabled: false
    thresholdKb: 16

agentExecutor:
  replicas: 1
  # Agent executor backend: 'pool', 'ephemeral', 'direct', or 'auto' (default)
  backend: "auto"
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  queue: "shared-agent-queue"
  workerPoolSize: ""
  contextCompression:
    enabled: false
    thresholdKb: 16

temporal:
  enabled: true
  # Temporal task queue used by Tracecat workers.
  clusterQueue: tracecat-task-queue
  web:
    # Optional envFrom secret for Temporal Web UI auth settings.
    # Set to temporal-ui-oidc (or your secret name) to enable OIDC auth via secret keys.
    additionalEnvSecretName: ""
  server:
    config:
      persistence:
        defaultStore: default
        visibilityStore: visibility
        numHistoryShards: 1024
        # Configure these when using self-hosted Temporal with an external database.
        # See deployments/terraform/aws/modules/eks/helm.tf for a production example.
        datastores:
          default:
            sql:
              pluginName: postgres12
              databaseName: temporal
              connectAddr: ""  # e.g. your-rds-host:5432
              connectProtocol: tcp
              user: ""
              password: ""
              # Keep this aligned with the secret used by Temporal SQL setup jobs.
              # If you change the postgres secret name, update this and visibility.sql.existingSecret.
              existingSecret: "tracecat-postgres-credentials"  # K8s secret with database password
              secretKey: password
              # Enables Temporal's schema job to cold-start external PostgreSQL
              # (create DB if missing, then setup/update schema).
              # Disable only if your DB role cannot CREATE DATABASE and DBs are pre-provisioned.
              createDatabase: true
              manageSchema: true
              maxConns: 20
              maxIdleConns: 20
          visibility:
            sql:
              pluginName: postgres12
              databaseName: temporal_visibility
              connectAddr: ""  # e.g. your-rds-host:5432
              connectProtocol: tcp
              user: ""
              password: ""
              # Keep this aligned with default.sql.existingSecret.
              existingSecret: "tracecat-postgres-credentials"  # K8s secret with database password
              secretKey: password
              # Same cold-start behavior as the default store.
              createDatabase: true
              manageSchema: true
              maxConns: 20
              maxIdleConns: 20
      # Namespace configuration (must be under server.config, not server)
      namespaces:
        create: true
        namespace:
          - name: default
            retention: 720h
    # Optional archival settings for self-hosted Temporal (chart 1.0.0-rc.1).
    # These are rendered from temporal/templates/server-configmap.yaml.
    # archival:
    #   history:
    #     state: "enabled"
    #     enableRead: true
    #     provider:
    #       s3store:
    #         region: "us-east-1"
    #   visibility:
    #     state: "enabled"
    #     enableRead: true
    #     provider:
    #       s3store:
    #         region: "us-east-1"
    # namespaceDefaults:
    #   archival:
    #     history:
    #       state: "enabled"
    #       URI: "s3://your-bucket/temporal-history"
    #     visibility:
    #       state: "enabled"
    #       URI: "s3://your-bucket/temporal-visibility"

externalPostgres:
  host: "example-db.example.com"
  port: 5432
  database: tracecat
  sslMode: "prefer"
  auth:
    # Either set a Kubernetes secret or an AWS Secrets Manager ARN.
    # You can set both to export TRACECAT__DB_PASS__ARN and TRACECAT__DB_PASS.
    # existingSecret is optional when secrets.create.postgres.enabled=true
    # or when externalSecrets.postgres is enabled with a secretArn.
    existingSecret: null  # Contains `username` and `password` (or enable secrets.create.postgres).
    # Username to use with secretArn (if omitted, the ARN secret must include `username`).
    username: ""
    # SecretString should be JSON with `password` (and optional `username`) or a raw password when username is set.
    secretArn: null
  tls:
    # Enable TLS certificate verification (requires caCert to be set)
    verifyCA: false
    # CA certificate for verifying the database server certificate (PEM format)
    # For AWS RDS, use the RDS CA bundle from https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
    caCert: ""

externalRedis:
  auth:
    # Either set a Kubernetes secret or an AWS Secrets Manager ARN.
    existingSecret: null  # Contains `url` (raw string)
    # SecretString should be the raw Redis URL.
    secretArn: null

externalS3:
  endpoint: ""
  region: ""
  auth:
    existingSecret: null  # Contains `accessKeyId` and `secretAccessKey` (optional for IRSA/IAM roles).

externalTemporal:
  enabled: false
  clusterUrl: ""
  clusterNamespace: ""
  # Temporal task queue used by Tracecat workers.
  clusterQueue: tracecat-task-queue
  auth:
    existingSecret: null  # Contains `apiKey` (raw string)
    # SecretString should be the raw API key.
    secretArn: null

# Stakater Reloader annotations for automatic pod restart on secret changes.
# When enabled, pods automatically restart when their referenced secrets are updated.
# This is critical for handling AWS Secrets Manager rotation (e.g., RDS password rotation).
reloader:
  enabled: true
