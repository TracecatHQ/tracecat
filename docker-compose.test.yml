# Docker Compose for running integration tests
# Usage: docker compose -f docker-compose.test.yml run --rm executor-test
#
# This extends docker-compose.dev.yml but uses the 'test' target which includes pytest.

services:
  executor-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    # Required for nsjail sandbox
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined
    environment:
      # Common
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      TRACECAT__APP_ENV: ${TRACECAT__APP_ENV:-development}
      TRACECAT__DB_ENCRYPTION_KEY: ${TRACECAT__DB_ENCRYPTION_KEY}
      TRACECAT__DB_SSLMODE: ${TRACECAT__DB_SSLMODE:-disable}
      TRACECAT__DB_URI: ${TRACECAT__DB_URI}
      TRACECAT__SERVICE_KEY: ${TRACECAT__SERVICE_KEY}
      TRACECAT__SIGNING_SECRET: ${TRACECAT__SIGNING_SECRET}
      TRACECAT__FEATURE_FLAGS: ${TRACECAT__FEATURE_FLAGS:-}
      TRACECAT__API_URL: ${TRACECAT__API_URL:-http://api:8000}
      # Registry
      TRACECAT__UNSAFE_DISABLE_SM_MASKING: ${TRACECAT__UNSAFE_DISABLE_SM_MASKING:-false}
      # Local registry
      TRACECAT__LOCAL_REPOSITORY_PATH: ${TRACECAT__LOCAL_REPOSITORY_PATH:-/app/local_registry}
      TRACECAT__LOCAL_REPOSITORY_ENABLED: ${TRACECAT__LOCAL_REPOSITORY_ENABLED:-true}
      # Sandbox
      TRACECAT__DISABLE_NSJAIL: ${TRACECAT__DISABLE_NSJAIL:-false}
      TRACECAT__SANDBOX_NSJAIL_PATH: /usr/local/bin/nsjail
      TRACECAT__SANDBOX_ROOTFS_PATH: /var/lib/tracecat/sandbox-rootfs
      TRACECAT__SANDBOX_CACHE_DIR: /var/lib/tracecat/sandbox-cache
      # Temporal (not needed for pool tests, but set for completeness)
      TEMPORAL__CLUSTER_URL: ${TEMPORAL__CLUSTER_URL:-temporal:7233}
      TEMPORAL__CLUSTER_NAMESPACE: ${TEMPORAL__CLUSTER_NAMESPACE:-default}
      # Executor worker configuration
      TRACECAT__EXECUTOR_QUEUE: ${TRACECAT__EXECUTOR_QUEUE:-shared-action-queue}
      TRACECAT__EXECUTOR_WORKER_POOL_SIZE: ${TRACECAT__EXECUTOR_WORKER_POOL_SIZE:-2}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      # Blob storage
      TRACECAT__BLOB_STORAGE_PROTOCOL: ${TRACECAT__BLOB_STORAGE_PROTOCOL:-minio}
      TRACECAT__BLOB_STORAGE_ENDPOINT: ${TRACECAT__BLOB_STORAGE_ENDPOINT:-http://minio:9000}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - ./tracecat:/app/tracecat
      - ./packages:/app/packages
      - ./tests:/app/tests
      - ${TRACECAT__LOCAL_REPOSITORY_PATH:-./local_registry}:/app/local_registry
    working_dir: /app
    # Override entrypoint to run pytest directly
    entrypoint: []
    command: ["python", "-m", "pytest", "tests/integration/test_sandboxed_pool_integration.py", "-v", "--tb=short"]
