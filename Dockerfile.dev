FROM ghcr.io/astral-sh/uv:0.4.20-python3.12-bookworm-slim

# Define the environment variables
ENV UV_SYSTEM_PYTHON=1
ENV HOST=0.0.0.0
ENV PORT=8000
ENV TRACECAT_ENVIRONMENT=development

# Expose the application port
EXPOSE $PORT

# Install packages
COPY scripts/install-packages.sh .
RUN chmod +x install-packages.sh && \
    ./install-packages.sh && \
    rm install-packages.sh

# Set up Podman
COPY scripts/setup-podman.sh .
COPY config/podman /app/config/podman
RUN chmod +x setup-podman.sh && \
    ./setup-podman.sh && \
    rm setup-podman.sh

# Set the working directory inside the container
WORKDIR /app

# Copy the application files into the container
COPY ./tracecat /app/tracecat
COPY ./registry /app/registry
COPY ./pyproject.toml /app/pyproject.toml
COPY ./README.md /app/README.md
COPY ./LICENSE /app/LICENSE
COPY ./alembic.ini /app/alembic.ini
COPY ./alembic /app/alembic

COPY scripts/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Install package and registry in editable mode
RUN uv pip install -e .
RUN uv pip install -e ./registry

ENTRYPOINT ["/app/entrypoint.sh"]

# Command to run the application
CMD ["sh", "-c", "python3 -m uvicorn tracecat.api.app:app --host $HOST --port $PORT --reload"]
