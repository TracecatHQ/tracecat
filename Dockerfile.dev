FROM ghcr.io/astral-sh/uv:0.9.7-python3.12-bookworm-slim

# Define the environment variables
ENV HOST=0.0.0.0
ENV PORT=8000

# Install packages
COPY docker/scripts/install-packages.sh .
RUN chmod +x install-packages.sh && \
    ./install-packages.sh && \
    rm install-packages.sh

# Set deno environment variables to use pre-cached modules
ENV DENO_DIR="/root/.deno"
ENV NODE_MODULES_DIR="/app/node_modules"
ENV NODE_ENV="development"

# Set temporary directory environment variables (for development)
ENV TMPDIR="/tmp"
ENV TEMP="/tmp"
ENV TMP="/tmp"

# Set the working directory inside the container
WORKDIR /app

# Prime uv's dependency cache using the lockfile before copying the working tree.
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    --mount=type=bind,source=packages,target=packages \
    uv sync --locked --no-install-project --no-dev --no-editable

# Copy the application files into the container
COPY ./tracecat /app/tracecat
COPY ./packages/tracecat-registry /app/packages/tracecat-registry
COPY ./packages/tracecat-ee /app/packages/tracecat-ee
COPY ./pyproject.toml /app/pyproject.toml
COPY ./uv.lock /app/uv.lock
COPY ./.python-version /app/.python-version
COPY ./README.md /app/README.md
COPY ./LICENSE /app/LICENSE
COPY ./alembic.ini /app/alembic.ini
COPY ./alembic /app/alembic

COPY docker/scripts/entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Materialize the venv while reusing the warmed cache for faster dev rebuilds.
RUN --mount=type=cache,target=/root/.cache/uv uv sync --frozen --no-dev

# Place executables in the environment at the front of the path
ENV PATH="/app/.venv/bin:$PATH"

# Ensure uv binary is available where Ray expects it
RUN mkdir -p /root/.local/bin && \
    ln -s $(which uv) /root/.local/bin/uv

# Create necessary directories for development
RUN mkdir -p /root/.deno /app/node_modules /app/.scripts && \
    # Copy pre-cached deno modules if they exist
    cp -r /opt/deno-cache/* /root/.deno/ 2>/dev/null || true && \
    # Copy node_modules if they exist
    cp -r /opt/node_modules/* /app/node_modules/ 2>/dev/null || true && \
    # Clean up
    rm -rf /opt/deno-cache /opt/node_modules

ENTRYPOINT ["/app/entrypoint.sh"]

EXPOSE $PORT

# Command to run the application. This uses the venv python.
CMD ["sh", "-c", "python3 -m uvicorn tracecat.api.app:app --host $HOST --port $PORT --reload"]
