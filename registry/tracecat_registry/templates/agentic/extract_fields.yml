type: action
definition:
  title: Extract important fields
  description: Extract and analyze important fields from an alert.
  display_group: Agents
  namespace: agentic
  name: extract_fields
  expects:
    alert:
      type: dict[str, any]
      description: Alert to extract important fields from.
    alert_context:
      type: str
      description: What are the alerts about? Where did they come from?
    analyst_context:
      type: str
      description: >
        Who is the analyst examining these alerts?
        What is their role? For what organization?
  steps:
    - ref: structured_output
      action: core.transform.reshape
      args:
        value:
          type: json_schema
          name: important_fields
          description: Extract and analyze important fields from an alert
          strict: true
          schema:
            type: object
            required:
              - thoughts
              - important_fields
            additionalProperties: false
            properties:
              thoughts:
                type: array
                items:
                  type: string
                  description: Thoughts about the alert's important fields
              important_fields:
                type: array
                items:
                  type: object
                  required:
                    - name
                    - value
                    - description
                    - information_type
                    - is_potential_ioc
                    - requires_enrichment
                    - needs_organization_context
                    - thoughts
                  additionalProperties: false
                  properties:
                    name:
                      type: string
                      description: Human readable name of the field.
                    value:
                      type: string
                      description: Value of the field.
                    description:
                      type: string
                      description: One sentence description of the field.
                    information_type:
                      type: string
                      enum:
                        - who
                        - what
                        - when
                        - where
                        - why
                        - how
                      description: What type of information (5W1H) does this field contain?
                    is_potential_ioc:
                      type: boolean
                      description: Is this field a potential indicator of compromise (IoC)?
                    requires_enrichment:
                      type: boolean
                      description: Does this field require enrichment from threat intelligence sources (e.g. VirusTotal)?
                    needs_organization_context:
                      type: boolean
                      description: Does this field require additional organization-specific context to be useful?
                    thoughts:
                      type: string
                      description: Thoughts about this field in the alert.
    - ref: extract_fields
      action: llm.openai.call
      args:
        prompt: >
          <alert>
          ${{ inputs.alert }}
          </alert>
        instructions: >
          <alert_context>
          ${{ inputs.alert_context }}
          </alert_context>

          <analyst_context>
          ${{ inputs.analyst_context }}
          </analyst_context>

          <analysis_process>
          Approach this analysis systematically:
          1. First review the entire alert to understand the full context
          2. Identify fields that could indicate malicious activity
          3. Look for relationships between fields
          4. Consider what additional context might be needed
          </analysis_process>

          <output_format>
          Example output format:
          {
            "thoughts": [
              "Initial observation: According to the alert summary, this is a login attempt from an unusual IP address",
              "The alert context includes information that this user is a high-value target"
            ],
            "important_fields": [
              {
                "name": "source_ip",
                "value": "192.168.1.1",
                "description": "IP address where the login attempt originated",
                "information_type": "where",
                "is_potential_ioc": true,
                "requires_enrichment": true,
                "needs_organization_context": false,
                "thoughts": "This IP is from a different country than the user normally accesses from"
              }
            ]
          }
          </output_format>

          <task>
          Extract and analyze important fields from the alert.
          You must only extract specific, actual values from the alert.
          </task>
        text_format: ${{ steps.structured_output.result }}
  returns: ${{ FN.deserialize_json(steps.extract_fields.result.output_text) }}
