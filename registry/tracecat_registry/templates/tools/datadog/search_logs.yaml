type: action
definition:
  title: Search logs
  description: Search Datadog logs using the logs API to retrieve log data over a specified time range.
  display_group: Datadog
  doc_url: https://docs.datadoghq.com/api/latest/logs/#search-logs
  namespace: tools.datadog
  name: search_logs
  secrets:
    - name: datadog
      keys: ["DD_API_KEY", "DD_APPLICATION_KEY"]
  expects:
    query:
      type: str
      description: Search query for logs (e.g., "service:web", "ERROR", "host:production").
      default: ""
    from_time:
      type: str
      description: Start time for the query range.
    to_time:
      type: str
      description: End time for the query range
    limit:
      type: int
      description: Maximum number of logs to return.
      default: 50
    sort:
      type: str
      description: Sort order for logs. Either "timestamp" (ascending) or "-timestamp" (descending).
      default: "-timestamp"
    timezone:
      type: str
      description: Timezone for the query (e.g., "GMT", "UTC", "America/New_York").
      default: "UTC"
    indexes:
      type: list[str]
      description: List of log indexes to search (e.g., ["main", "audit"]).
      default: []
    base_url:
      type: str
      description: Datadog API base URL (e.g., https://api.datadoghq.com, https://api.us3.datadoghq.com).
      default: "https://api.datadoghq.com"
  steps:
    - ref: datadog_search_logs
      action: core.http_request
      args:
        url: ${{ inputs.base_url }}/api/v2/logs/events/search
        method: POST
        headers:
          Accept: application/json
          Content-Type: application/json
          DD-API-KEY: ${{ SECRETS.datadog.DD_API_KEY }}
          DD-APPLICATION-KEY: ${{ SECRETS.datadog.DD_APPLICATION_KEY }}
        payload:
          filter:
            query: ${{ inputs.query }}
            from: ${{ inputs.from_time }}
            to: ${{ inputs.to_time }}
            indexes: ${{ inputs.indexes }}
          sort: ${{ inputs.sort }}
          page:
            limit: ${{ inputs.limit }}
          options:
            timezone: ${{ inputs.timezone }}
    - ref: human_readable
      action: core.transform.reshape
      args:
        value:
          status: "success"
          query: ${{ inputs.query }}
          time_range:
            from: ${{ inputs.from_time }}
            to: ${{ inputs.to_time }}
            timezone: ${{ inputs.timezone }}
          query_time_ms: ${{ steps.datadog_search_logs.result.data.meta.elapsed }}
          logs: ${{ steps.datadog_search_logs.result.data.data }}
  returns: ${{ steps.human_readable.result }}
