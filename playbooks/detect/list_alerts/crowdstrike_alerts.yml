definition:
  title: List, normalize, and redirect Crowdstrike alerts
  description: |
    Pulls Crowdstrike alerts, normalizes alerts into ECS format
    and triggers a child workflow for each alert.
  entrypoint:
    ref: list_crowdstrike_alerts
    expects:
      start_time: str
      interval_minutes: str
      filter: str
      child_workflow_id: str
  triggers:
    - type: webhook
      ref: crowdstrike_alerts_webhook
      entrypoint: list_crowdstrike_alerts
  inputs:
    limit: 10
    batch_size: 10

  actions:
    - ref: list_crowdstrike_alerts
      action: integrations.crowdstrike.list_crowdstrike_alerts
      args:
        start_time: ${{ TRIGGER.start_time }}
        end_time: ${{  }}
        filter: ${{ TRIGGER.filter }}
        limit: ${{ INPUTS.limit }}

    - ref: normalize_crowdstrike_alerts
      action: etl.normalization.normalize_events_to_ecs
      depends_on:
        - list_crowdstrike_alerts
      run_if: ${{ FN.not_empty(ACTIONS.list_crowdstrike_alerts.result) }}
      args:
        pipeline: https://github.com/elastic/integrations/blob/main/packages/crowdstrike/data_stream/alert/elasticsearch/ingest_pipeline/default.yml
        data: ${{ ACTION.list_crowdstrike_alerts.result }}

    - ref: redirect_crowdstrike_alerts
      action: core.workflow.execute
      depends_on:
        - normalize_crowdstrike_alerts
      run_if: ${{ FN.not_empty(ACTIONS.normalize_crowdstrike_alerts.result) }}
      for_each: ${{ for var.alert in ACTIONS.normalize_crowdstrike_alerts.result }}
      args:
        workflow_id: ${{ TRIGGER.child_workflow_id }}
        loop_strategy: parallel
        fail_strategy: isolated
        batch_size: ${{ INPUTS.batch_size }}
        trigger_inputs:
          alert: ${{ var.alert }}
