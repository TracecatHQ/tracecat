definition:
  title: List Microsoft Defender alerts
  description: |
    Given Microsoft Defender `service_source` (e.g. 'microsoftDefenderForCloud'),
    return list of alerts filtered by `start_time` and `end_time`.

    Requires secret named `microsoft_defender` with keys:
    - `TENANT_ID`
    - `OAUTH_CLIENT_ID`
    - `OAUTH_CLIENT_SECRET`.
  entrypoint:
    ref: list_alerts
    expects:
      service_source: str
      start_time: datetime
      end_time: datetime
      limit: int
  triggers:
    - type: webhook
      ref: receive_defender_query
      entrypoint: list_alerts
  inputs:
    base_url: https://graph.microsoft.com/v1.0
    endpoint: security/alerts_v2
    oauth2_endpoint: /oauth2/v2.0/token

  actions:
    - ref: list_defender_alerts
      action: core.http_request
      args:
        method: GET
        url: ${{ INPUTS.base_url }}/${{ INPUTS.endpoint }}
        oauth2_url: https://login.microsoftonline.com/${{ SECRETS.microsoft_defender.TENANT_ID }}/${{ INPUTS.oauth2_endpoint }}
        oauth2_client_id: ${{ SECRETS.microsoft_defender.OAUTH_CLIENT_ID }}
        oauth2_client_secret: ${{ SECRETS.microsoft_defender.OAUTH_CLIENT_SECRET }}
        oauth2_grant_type: client_credentials
        oauth2_scope: https://graph.microsoft.com/.default
        payload:
          serviceSource: ${{ TRIGGER.service_source }}
          $top: ${{ TRIGGER.limit }}
          $filter: "createdDateTime ge ${{ FN.to_isoformat(TRIGGER.start_time) }}Z and createdDateTime le ${{ FN.to_isoformat(TRIGGER.end_time) }}Z"
