name: Run Python tests

on:
  push:
    branches: ["main"]
    paths:
      - tracecat/**
      - registry/**
      - tests/**
      - packages/tracecat-ee/**
      - packages/tracecat-registry/**
      - pyproject.toml
      - uv.lock
      - Dockerfile
      - docker-compose.yml
      - docker-compose.dev.yml
      - docker-compose.local.yml
      - .github/workflows/test-python.yml
  pull_request:
    branches: ["main", "staging"]
    paths:
      - tracecat/**
      - registry/**
      - tests/**
      - packages/tracecat-ee/**
      - packages/tracecat-registry/**
      - pyproject.toml
      - uv.lock
      - Dockerfile
      - docker-compose.yml
      - docker-compose.dev.yml
      - docker-compose.local.yml
      - .github/workflows/test-python.yml
  workflow_dispatch:
    inputs:
      git-ref:
        description: "Git Ref (optional)"
        required: false
        default: ""

permissions:
  contents: read
  packages: write

env:
  UV_SYSTEM_PYTHON: 1

jobs:
  test-custom-registry-install:
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git-ref || github.ref }}

      - name: Install uv
        uses: useblacksmith/setup-uv@v4
        with:
          version: "0.9.7"

      - name: Set up Python 3.12
        uses: useblacksmith/setup-python@v6
        with:
          python-version: "3.12"

      - name: Clone custom registry starter
        run: |
          git clone https://github.com/TracecatHQ/custom-integrations-starter-kit
          cd custom-integrations-starter-kit

      - name: Install dependencies
        run: uv sync --frozen

  test-all:
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 60
    strategy:
      matrix:
        test_group:
          - unit
          - registry
          - temporal
          # - ee # TODO: re-enable this when we have tests
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git-ref || github.ref }}

      - name: Install uv
        uses: useblacksmith/setup-uv@v4
        with:
          version: "0.9.7"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python 3.12
        uses: useblacksmith/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Run environment setup script
        run: |
          echo "y
          localhost
          n
          test@tracecat.com" | bash env.sh

      - name: Start core Docker services
        env:
          COMPOSE_BAKE: "true"
          TRACECAT__UNSAFE_DISABLE_SM_MASKING: "true"
        run: docker compose -f docker-compose.dev.yml up -d temporal api postgres_db caddy minio

      - name: Install dependencies
        run: uv sync --frozen

      - name: Run tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          TRACECAT__SYSTEM_PATH: "/usr/local/bin:/usr/bin:/bin"
          TRACECAT__EXECUTOR_BACKEND: "direct"
          TRACECAT__WORKFLOW_RETURN_STRATEGY: "context"
          TRACECAT__UNSAFE_DISABLE_SM_MASKING: "true"
        run: |
          if [ "${{ matrix.test_group }}" = "ee" ]; then
            uv run pytest packages/tracecat-ee/tests/ -ra
          elif [ "${{ matrix.test_group }}" = "temporal" ]; then
            # Temporal tests run with compression enabled and parallelization
            # Worker-specific task queues in conftest.py enable safe parallel execution
            TRACECAT__CONTEXT_COMPRESSION_ENABLED=true \
            TRACECAT__CONTEXT_COMPRESSION_THRESHOLD_KB=0 \
            uv run pytest tests/temporal -n auto -ra -o faulthandler_timeout=300
          else
            uv run pytest tests/${{ matrix.test_group }} -n auto -ra -o faulthandler_timeout=300
          fi

      - name: Show Docker logs on failure
        if: failure()
        run: |
          echo "=== Docker Service Status ==="
          docker compose -f docker-compose.dev.yml ps

          echo "=== Temporal Logs ==="
          docker compose -f docker-compose.dev.yml logs temporal --tail=200

          echo "=== API Logs ==="
          docker compose -f docker-compose.dev.yml logs api --tail=200

          echo "=== Postgres Logs ==="
          docker compose -f docker-compose.dev.yml logs postgres_db --tail=200
