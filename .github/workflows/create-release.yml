name: Create release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: >-
          Version to release (e.g. 0.20.0, 0.20.0-beta.0).
          Leave empty to auto-increment the patch version.
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: create-release
  cancel-in-progress: false

jobs:
  create-release:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Ensure workflow runs from main
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "$REF_NAME" != "main" ]; then
            echo "This workflow must be run from the main branch (current: $REF_NAME)" >&2
            exit 1
          fi

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Sync with latest main
        run: |
          git fetch origin main --tags
          git checkout main
          git reset --hard origin/main

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        env:
          TAG: ${{ inputs.tag }}
        run: yes | ./scripts/update-version.sh $TAG

      - name: Read version
        id: version
        run: |
          VERSION=$(grep -oP '__version__ = "\K[^"]+' tracecat/__init__.py)
          if [ -z "$VERSION" ]; then
            echo "Failed to read version from tracecat/__init__.py" >&2
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Ensure version has not already been published
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.version }}
        with:
          script: |
            const version = process.env.VERSION
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            })

            const publishedRelease = releases.find(
              (release) => !release.draft && release.tag_name === version,
            )
            if (publishedRelease) {
              core.setFailed(
                `Release ${version} is already published (release id ${publishedRelease.id}). Bump version before running create-release.`,
              )
              return
            }

      - name: Commit version bump to release branch
        run: |
          if git diff --quiet; then
            echo "No version changes were generated by update-version.sh." >&2
            exit 1
          fi

          VERSION="${{ steps.version.outputs.version }}"
          BRANCH="release/${VERSION}"

          git checkout -b "$BRANCH"
          git add -A
          git commit -m "release: ${VERSION}"
          git push origin "$BRANCH"

          echo "Release branch '$BRANCH' pushed."
          echo "Create a PR from '$BRANCH' into main and merge it to trigger the publish-release workflow."
