type: action
definition:
  title: Add comment
  description: Add a comment to a Confluence page.
  display_group: Confluence
  doc_url: https://docs.atlassian.com/atlassian-confluence/REST/6.6.0/#content/{id}/child-commentsOfContent
  namespace: tools.confluence
  name: add_page_comment
  secrets:
    - name: confluence
      keys: ["CONFLUENCE_USERNAME", "CONFLUENCE_API_TOKEN"]
  expects:
    page_id:
      type: str
      description: The ID of the page to comment on.
    content:
      type: str
      description: Comment content in Confluence storage (XHTML) or wiki markup. Convert Markdown to storage before sending if needed.
    content_representation:
      type: str
      description: Content representation for the comment body (storage or wiki).
      default: storage
    base_url:
      type: str | None
      description: Confluence site base URL (e.g., https://example.atlassian.net/wiki). Do not append /rest/api.
      default: null
  steps:
    - ref: build_payload
      action: core.script.run_python
      args:
        inputs:
          content: ${{ inputs.content }}
          representation: ${{ inputs.content_representation }}
        script: |
          def main(content, representation):
              return {
                  "type": "comment",
                  "body": {
                      representation: {
                          "value": content,
                          "representation": representation,
                      }
                  },
              }
    - ref: add_comment
      action: core.http_request
      args:
        url: ${{ inputs.base_url || VARS.confluence.base_url }}/rest/api/content/${{ FN.url_encode(inputs.page_id) }}/child/comment
        method: POST
        headers:
          Content-Type: application/json
        auth:
          username: ${{ SECRETS.confluence.CONFLUENCE_USERNAME }}
          password: ${{ SECRETS.confluence.CONFLUENCE_API_TOKEN }}
        payload: ${{ steps.build_payload.result.data }}
  returns: ${{ steps.add_comment.result.data }}
