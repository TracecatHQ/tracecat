type: action
definition:
  title: Update incident
  description: Update an existing incident by number or sys_id.
  display_group: ServiceNow
  doc_url: https://developer.servicenow.com/dev.do#!/reference/api/u_tahoe/rest/c_TableAPI#r_TableAPI-PUT
  namespace: tools.servicenow
  name: update_incident
  secrets:
    - name: servicenow
      keys: ["SERVICENOW_USERNAME", "SERVICENOW_PASSWORD"]
expects:
  instance_url:
    type: str | None
    description: ServiceNow instance URL (e.g., https://your-instance.service-now.com)
    default: null
  incident_id:
    type: str
    description: Incident number (e.g., INC0010001) or sys_id.
  short_description:
    type: str | None
    description: Updated short description.
    default: null
  description:
    type: str | None
    description: Detailed description.
    default: null
  state:
    type: str | None
    description: Incident state code.
    default: null
  category:
    type: str | None
    description: Category value.
    default: null
  subcategory:
    type: str | None
    description: Subcategory value.
    default: null
  priority:
    type: str | None
    description: Priority value.
    default: null
  impact:
    type: str | None
    description: Impact value.
    default: null
  urgency:
    type: str | None
    description: Urgency value.
    default: null
  assigned_to:
    type: str | None
    description: User assigned to the incident.
    default: null
  assignment_group:
    type: str | None
    description: Group assigned to the incident.
    default: null
  work_notes:
    type: str | None
    description: Work notes to append.
    default: null
  close_notes:
    type: str | None
    description: Closure notes.
    default: null
  close_code:
    type: str | None
    description: Closure code.
    default: null
steps:
  - ref: lookup_incident
    action: core.http_request
    args:
      method: GET
      url: ${{ (inputs.instance_url || VARS.servicenow.instance_url) }}/api/now/table/incident
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      params:
        sysparm_query: number=${{ FN.url_encode(inputs.incident_id) }}^ORsys_id=${{ FN.url_encode(inputs.incident_id) }}
        sysparm_limit: 1
        sysparm_display_value: true
  - ref: resolve_incident
    action: core.script.run_python
    args:
      inputs:
        lookup: ${{ steps.lookup_incident.result.data.result }}
        incident_id: ${{ inputs.incident_id }}
      script: |
        def main(lookup, incident_id):
            sys_id = incident_id
            if isinstance(lookup, list) and lookup:
                sys_id = lookup[0].get("sys_id", incident_id)
            elif isinstance(lookup, dict) and lookup:
                sys_id = lookup.get("sys_id", incident_id)
            return {"sys_id": sys_id}
  - ref: build_payload
    action: core.script.run_python
    args:
      inputs:
        short_description: ${{ inputs.short_description }}
        description: ${{ inputs.description }}
        state: ${{ inputs.state }}
        category: ${{ inputs.category }}
        subcategory: ${{ inputs.subcategory }}
        priority: ${{ inputs.priority }}
        impact: ${{ inputs.impact }}
        urgency: ${{ inputs.urgency }}
        assigned_to: ${{ inputs.assigned_to }}
        assignment_group: ${{ inputs.assignment_group }}
        work_notes: ${{ inputs.work_notes }}
        close_notes: ${{ inputs.close_notes }}
        close_code: ${{ inputs.close_code }}
      script: |
        def main(short_description=None, description=None, state=None, category=None, subcategory=None,
                 priority=None, impact=None, urgency=None, assigned_to=None, assignment_group=None,
                 work_notes=None, close_notes=None, close_code=None):
            payload = {}
            optional = {
                "short_description": short_description,
                "description": description,
                "state": state,
                "category": category,
                "subcategory": subcategory,
                "priority": priority,
                "impact": impact,
                "urgency": urgency,
                "assigned_to": assigned_to,
                "assignment_group": assignment_group,
                "work_notes": work_notes,
                "close_notes": close_notes,
                "close_code": close_code,
            }
            for key, value in optional.items():
                if value is not None:
                    payload[key] = value
            return payload
  - ref: update_incident
    action: core.http_request
    args:
      method: PUT
      url: ${{ (inputs.instance_url || VARS.servicenow.instance_url) }}/api/now/table/incident/${{ FN.url_encode(steps.resolve_incident.result.sys_id) }}
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      headers:
        Accept: application/json
        Content-Type: application/json
      payload: ${{ steps.build_payload.result }}
returns: ${{ steps.update_incident.result.data }}
