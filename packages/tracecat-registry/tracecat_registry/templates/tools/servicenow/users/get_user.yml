type: action
definition:
  title: Get user
  description: Retrieve a user by sys_id, username, or email.
  display_group: ServiceNow
  doc_url: https://developer.servicenow.com/dev.do#!/reference/api/u_tahoe/rest/c_TableAPI#r_TableAPI-GET
  namespace: tools.servicenow
  name: get_user
  secrets:
    - name: servicenow
      keys: ["SERVICENOW_USERNAME", "SERVICENOW_PASSWORD"]
expects:
  base_url:
    type: str | None
    description: ServiceNow base URL (e.g., https://your-instance.service-now.com)
    default: null
  user_id:
    type: str | None
    description: User sys_id.
    default: null
  user_name:
    type: str | None
    description: Username to search.
    default: null
  email:
    type: str | None
    description: Email address to search.
    default: null
steps:
  - ref: resolve_base_url
    action: core.script.run_python
    args:
      inputs:
        base_url: ${{ inputs.base_url or VARS.servicenow.base_url }}
      script: |
        from urllib.parse import urlparse

        def main(base_url=None):
            if not base_url:
                raise ValueError("ServiceNow base_url is required")

            parsed = urlparse(base_url)
            if parsed.scheme != "https":
                raise ValueError("ServiceNow base_url must use https")
            if not parsed.hostname or not parsed.hostname.endswith("service-now.com"):
                raise ValueError("ServiceNow base_url must be a service-now.com host")

            return {"base_url": base_url.rstrip("/")}
  - ref: build_query
    action: core.script.run_python
    args:
      inputs:
        user_id: ${{ inputs.user_id }}
        user_name: ${{ inputs.user_name }}
        email: ${{ inputs.email }}
      script: |
        from urllib.parse import quote_plus


        def main(user_id=None, user_name=None, email=None):
            if user_id:
                return {"query": f"sys_id={quote_plus(user_id, safe='')}"}
            if user_name:
                return {"query": f"user_name={quote_plus(user_name, safe='')}"}
            if email:
                return {"query": f"email={quote_plus(email, safe='')}"}
            raise ValueError("Provide user_id, user_name, or email")
  - ref: get_user
    action: core.http_request
    args:
      method: GET
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      params:
        sysparm_query: ${{ steps.build_query.result.query }}
        sysparm_limit: 1
        sysparm_display_value: true
returns: ${{ steps.get_user.result.data }}
