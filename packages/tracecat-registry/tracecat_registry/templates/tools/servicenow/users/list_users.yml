type: action
definition:
  title: List users
  description: List users with optional filters.
  display_group: ServiceNow
  doc_url: https://developer.servicenow.com/dev.do#!/reference/api/u_tahoe/rest/c_TableAPI#r_TableAPI-GET
  namespace: tools.servicenow
  name: list_users
  secrets:
    - name: servicenow
      keys: ["SERVICENOW_USERNAME", "SERVICENOW_PASSWORD"]
expects:
  base_url:
    type: str | None
    description: ServiceNow base URL (e.g., https://your-instance.service-now.com)
    default: null
  limit:
    type: int
    description: Maximum number of users to return.
    default: 10
  offset:
    type: int
    description: Pagination offset.
    default: 0
  active:
    type: bool | None
    description: Filter by active status.
    default: null
  department:
    type: str | None
    description: Filter by department sys_id.
    default: null
  query:
    type: str | None
    description: Search text to match name, username, or email.
    default: null
steps:
  - ref: resolve_base_url
    action: core.script.run_python
    args:
      inputs:
        base_url: ${{ inputs.base_url or VARS.servicenow.base_url }}
      script: |
        from urllib.parse import urlparse

        def main(base_url=None):
            if not base_url:
                raise ValueError("ServiceNow base_url is required")

            parsed = urlparse(base_url)
            if parsed.scheme != "https":
                raise ValueError("ServiceNow base_url must use https")
            if not parsed.hostname or not parsed.hostname.endswith("service-now.com"):
                raise ValueError("ServiceNow base_url must be a service-now.com host")

            return {"base_url": base_url.rstrip("/")}
  - ref: build_params
    action: core.script.run_python
    args:
      inputs:
        limit: ${{ inputs.limit }}
        offset: ${{ inputs.offset }}
        active: ${{ inputs.active }}
        department: ${{ inputs.department }}
        query: ${{ inputs.query }}
      script: |
        from urllib.parse import quote_plus


        def main(limit, offset, active=None, department=None, query=None):
            params = {
                "sysparm_limit": limit,
                "sysparm_offset": offset,
                "sysparm_display_value": "true",
            }
            base_filters = []
            if active is not None:
                base_filters.append(f"active={quote_plus(str(active).lower(), safe='')}")
            if department:
                base_filters.append(f"department={quote_plus(department, safe='')}")
            if query:
                safe_query = quote_plus(query, safe="")
                branches = [
                    "^".join(base_filters + [f"nameLIKE{safe_query}"]),
                    "^".join(base_filters + [f"user_nameLIKE{safe_query}"]),
                    "^".join(base_filters + [f"emailLIKE{safe_query}"]),
                ]
                params["sysparm_query"] = "^NQ".join(branches)
            elif base_filters:
                params["sysparm_query"] = "^".join(base_filters)
            return params
  - ref: list_users
    action: core.http_request
    args:
      method: GET
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      params: ${{ steps.build_params.result }}
returns: ${{ steps.list_users.result.data }}
