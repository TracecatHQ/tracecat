type: action
definition:
  title: Remove group member
  description: Remove a user from a group (resolves username, email, or sys_id).
  display_group: ServiceNow
  doc_url: https://developer.servicenow.com/dev.do#!/reference/api/u_tahoe/rest/c_TableAPI#r_TableAPI-DELETE
  namespace: tools.servicenow
  name: remove_group_members
  secrets:
    - name: servicenow
      keys: ["SERVICENOW_USERNAME", "SERVICENOW_PASSWORD"]
expects:
  base_url:
    type: str | None
    description: ServiceNow base URL (e.g., https://your-instance.service-now.com)
    default: null
  group_id:
    type: str
    description: Group sys_id.
  member:
    type: str
    description: User identifier (sys_id, username, or email).
steps:
  - ref: resolve_base_url
    action: core.script.run_python
    args:
      inputs:
        base_url: ${{ inputs.base_url or VARS.servicenow.base_url }}
      script: |
        from urllib.parse import urlparse

        def main(base_url=None):
            if not base_url:
                raise ValueError("ServiceNow base_url is required")

            parsed = urlparse(base_url)
            if parsed.scheme != "https":
                raise ValueError("ServiceNow base_url must use https")
            if not parsed.hostname or not parsed.hostname.endswith("service-now.com"):
                raise ValueError("ServiceNow base_url must be a service-now.com host")

            return {"base_url": base_url.rstrip("/")}
  - ref: lookup_user
    action: core.http_request
    args:
      method: GET
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      params:
        sysparm_query: sys_id=${{ FN.url_encode(inputs.member) }}^ORuser_name=${{ FN.url_encode(inputs.member) }}^ORemail=${{ FN.url_encode(inputs.member) }}
        sysparm_limit: 1
  - ref: resolve_user
    action: core.script.run_python
    args:
      inputs:
        lookup: ${{ steps.lookup_user.result.data.result }}
        member: ${{ inputs.member }}
      script: |
        def main(lookup, member):
            if isinstance(lookup, list) and lookup:
                return {"user_id": lookup[0].get("sys_id", member)}
            if isinstance(lookup, dict) and lookup:
                return {"user_id": lookup.get("sys_id", member)}
            return {"user_id": member}
  - ref: lookup_membership
    action: core.http_request
    args:
      method: GET
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user_grmember
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      params:
        sysparm_query: group=${{ FN.url_encode(inputs.group_id) }}^user=${{ FN.url_encode(steps.resolve_user.result.user_id) }}
        sysparm_limit: 1
  - ref: resolve_membership
    action: core.script.run_python
    args:
      inputs:
        membership: ${{ steps.lookup_membership.result.data.result }}
      script: |
        def main(membership):
            if isinstance(membership, list) and membership:
                return {"membership_id": membership[0].get("sys_id")}
            if isinstance(membership, dict):
                return {"membership_id": membership.get("sys_id")}
            return {"membership_id": None}
  - ref: ensure_membership_exists
    action: core.script.run_python
    args:
      inputs:
        membership_id: ${{ steps.resolve_membership.result.membership_id }}
      script: |
        def main(membership_id=None):
            if not membership_id:
                raise ValueError("User is not a member of the group")

            return {"membership_id": membership_id}
  - ref: delete_membership
    action: core.http_request
    args:
      method: DELETE
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user_grmember/${{ FN.url_encode(steps.ensure_membership_exists.result.membership_id) }}
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      headers:
        Accept: application/json
returns: ${{ steps.delete_membership.result.data }}
