type: action
definition:
  title: Update group
  description: Update a user group.
  display_group: ServiceNow
  doc_url: https://developer.servicenow.com/dev.do#!/reference/api/u_tahoe/rest/c_TableAPI#r_TableAPI-PATCH
  namespace: tools.servicenow
  name: update_group
  secrets:
    - name: servicenow
      keys: ["SERVICENOW_USERNAME", "SERVICENOW_PASSWORD"]
expects:
  base_url:
    type: str | None
    description: ServiceNow base URL (e.g., https://your-instance.service-now.com)
    default: null
  group_id:
    type: str
    description: Group sys_id.
  name:
    type: str | None
    description: Group name.
    default: null
  description:
    type: str | None
    description: Group description.
    default: null
  manager:
    type: str | None
    description: Manager sys_id or username.
    default: null
  parent:
    type: str | None
    description: Parent group sys_id.
    default: null
  type:
    type: str | None
    description: Group type.
    default: null
  email:
    type: str | None
    description: Group email.
    default: null
  active:
    type: bool | None
    description: Whether the group is active.
    default: null
steps:
  - ref: resolve_base_url
    action: core.script.run_python
    args:
      inputs:
        base_url: ${{ inputs.base_url or VARS.servicenow.base_url }}
      script: |
        from urllib.parse import urlparse

        def main(base_url=None):
            if not base_url:
                raise ValueError("ServiceNow base_url is required")

            parsed = urlparse(base_url)
            if parsed.scheme != "https":
                raise ValueError("ServiceNow base_url must use https")
            if not parsed.hostname or not parsed.hostname.endswith("service-now.com"):
                raise ValueError("ServiceNow base_url must be a service-now.com host")

            return {"base_url": base_url.rstrip("/")}
  - ref: build_payload
    action: core.script.run_python
    args:
      inputs:
        name: ${{ inputs.name }}
        description: ${{ inputs.description }}
        manager: ${{ inputs.manager }}
        parent: ${{ inputs.parent }}
        type: ${{ inputs.type }}
        email: ${{ inputs.email }}
        active: ${{ inputs.active }}
      script: |
        def main(name=None, description=None, manager=None, parent=None, type=None, email=None, active=None):
            payload = {}
            optional = {
                "name": name,
                "description": description,
                "manager": manager,
                "parent": parent,
                "type": type,
                "email": email,
            }
            if active is not None:
                optional["active"] = str(bool(active)).lower()
            for key, value in optional.items():
                if value is not None:
                    payload[key] = value
            return payload
  - ref: update_group
    action: core.http_request
    args:
      method: PATCH
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user_group/${{ FN.url_encode(inputs.group_id) }}
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      headers:
        Accept: application/json
        Content-Type: application/json
      payload: ${{ steps.build_payload.result }}
returns: ${{ steps.update_group.result.data }}
