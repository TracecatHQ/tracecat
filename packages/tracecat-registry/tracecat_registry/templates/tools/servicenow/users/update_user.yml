type: action
definition:
  title: Update user
  description: Update user fields by sys_id.
  display_group: ServiceNow
  doc_url: https://developer.servicenow.com/dev.do#!/reference/api/u_tahoe/rest/c_TableAPI#r_TableAPI-PATCH
  namespace: tools.servicenow
  name: update_user
  secrets:
    - name: servicenow
      keys: ["SERVICENOW_USERNAME", "SERVICENOW_PASSWORD"]
expects:
  base_url:
    type: str | None
    description: ServiceNow base URL (e.g., https://your-instance.service-now.com)
    default: null
  user_id:
    type: str
    description: User sys_id.
  user_name:
    type: str | None
    description: Username.
    default: null
  first_name:
    type: str | None
    description: First name.
    default: null
  last_name:
    type: str | None
    description: Last name.
    default: null
  email:
    type: str | None
    description: Email address.
    default: null
  title:
    type: str | None
    description: Job title.
    default: null
  department:
    type: str | None
    description: Department sys_id.
    default: null
  manager:
    type: str | None
    description: Manager sys_id or username.
    default: null
  phone:
    type: str | None
    description: Phone number.
    default: null
  mobile_phone:
    type: str | None
    description: Mobile phone number.
    default: null
  location:
    type: str | None
    description: Location sys_id.
    default: null
  password:
    type: str | None
    description: Updated password.
    default: null
  active:
    type: bool | None
    description: Whether the user is active.
    default: null
steps:
  - ref: resolve_base_url
    action: core.script.run_python
    args:
      inputs:
        base_url: ${{ inputs.base_url or VARS.servicenow.base_url }}
      script: |
        from urllib.parse import urlparse

        def main(base_url=None):
            if not base_url:
                raise ValueError("ServiceNow base_url is required")

            parsed = urlparse(base_url)
            if parsed.scheme != "https":
                raise ValueError("ServiceNow base_url must use https")
            if not parsed.hostname or not parsed.hostname.endswith("service-now.com"):
                raise ValueError("ServiceNow base_url must be a service-now.com host")

            return {"base_url": base_url.rstrip("/")}
  - ref: build_payload
    action: core.script.run_python
    args:
      inputs:
        user_name: ${{ inputs.user_name }}
        first_name: ${{ inputs.first_name }}
        last_name: ${{ inputs.last_name }}
        email: ${{ inputs.email }}
        title: ${{ inputs.title }}
        department: ${{ inputs.department }}
        manager: ${{ inputs.manager }}
        phone: ${{ inputs.phone }}
        mobile_phone: ${{ inputs.mobile_phone }}
        location: ${{ inputs.location }}
        password: ${{ inputs.password }}
        active: ${{ inputs.active }}
      script: |
        def main(user_name=None, first_name=None, last_name=None, email=None, title=None, department=None, manager=None,
                 phone=None, mobile_phone=None, location=None, password=None, active=None):
            payload = {}
            optional = {
                "user_name": user_name,
                "first_name": first_name,
                "last_name": last_name,
                "email": email,
                "title": title,
                "department": department,
                "manager": manager,
                "phone": phone,
                "mobile_phone": mobile_phone,
                "location": location,
                "user_password": password,
            }
            if active is not None:
                optional["active"] = str(bool(active)).lower()
            for key, value in optional.items():
                if value is not None:
                    payload[key] = value
            return payload
  - ref: update_user
    action: core.http_request
    args:
      method: PATCH
      url: ${{ steps.resolve_base_url.result.base_url }}/api/now/table/sys_user/${{ FN.url_encode(inputs.user_id) }}
      auth:
        username: ${{ SECRETS.servicenow.SERVICENOW_USERNAME }}
        password: ${{ SECRETS.servicenow.SERVICENOW_PASSWORD }}
      headers:
        Accept: application/json
        Content-Type: application/json
      payload: ${{ steps.build_payload.result }}
returns: ${{ steps.update_user.result.data }}
